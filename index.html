<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Temperatura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="englife.icon" type="image/icon">
    <title>√çcone de Ajuda</title>
    <style>
        /* Estilos da Tela de Abertura */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(160deg, #ffffff 30%, #7fc5fa 50%);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease-in-out;
        }
        .card, #chart-container {
        background: rgba(255, 255, 255, 0.4) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gradient-bg {
        background: linear-gradient(
            135deg,
            rgba(176, 224, 255, 0.3) 0%,
            rgba(240, 248, 255, 0.2) 100%
        );
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
    }
        #splash-screen img {
            width: 350px;
            animation: 
                swim 2s ease-in-out infinite,
                float 3s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        }

        @keyframes swim {
            0% { transform: translateX(0) rotate(-5deg); }
            25% { transform: translateX(-15px) rotate(5deg); }
            50% { transform: translateX(0) rotate(-5deg); }
            75% { transform: translateX(15px) rotate(5deg); }
            100% { transform: translateX(0) rotate(-5deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* Estilos do conte√∫do principal */
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom, 
                #ffffff 0%, 
                #f0f8ff 100%
            );
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
        }

        .hidden-content {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .card {
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }

        /* Restante dos estilos... */
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .content {
            position: relative;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card-title {
            font-weight: bold;
            margin-bottom: 0;
        }
        .card-icon {
            font-size: 40px;
            margin-right: 15px;
        }
        .card-value {
            font-size: 20px;
            font-weight: bold;
        }
        #chart-container {
            margin-top: 20px;
            height: 400px;
        }
        .row {
            margin-top: 30px;
        }
        .btn-primary {
            font-size: 16px;
        }
        #notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: none;
    min-width: 300px;
    text-align: center;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

#notification.show {
    opacity: 1;
}
        /* Ajuste no body para o gradiente principal */
    body {
        background: linear-gradient(
            to bottom right,
            #e6f4ff,
            #227ebb
        );
        background-attachment: fixed;
    }

    /* Ajuste nas cores do texto para melhor contraste */
    .card-title, .card-value {
        color: #2c3e50 !important;
    }
    /* Novos estilos para alertas e configura√ß√£o */

    .sensor-alert {
    color: red !important; /* Texto vermelho quando h√° alerta */
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px; /* Espa√ßo entre o √≠cone e o texto */
}

.alert-icon {
    font-size: 22px;
    color: yellow;
    text-shadow: 0px 0px 3px black;
    animation: alert-pulse 1.5s infinite;
}

@keyframes alert-pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

/* Estiliza√ß√£o do bot√£o de ajuda */
.help-icon {
            position: fixed;
            bottom: 10px;
            right: 20px;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease-in-out;
        }

        .help-icon img {
            width: 100%;
            height: 100%;
        }

        .help-icon:hover {
            transform: scale(1.1);
        }







/* Progress Bar Improvements */
.progress {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-bar {
    position: relative;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    transition: width 0.5s ease;
    min-width: 40px; /* Garante visibilidade mesmo em % pequenas */
}

.progress-bar::after {
    content: '';
    position: absolute;
    right: -2px;
    height: 100%;
    width: 2px;
    background: rgba(255,255,255,0.3);
}

/* Badge Styling */
.badge {
    font-size: 0.9em;
    padding: 0.5em 0.8em;
    border-radius: 20px;
    width: 100%;
    margin: 2px 0;
}


/* Estilos da Calibra√ß√£o */
#calibracaoModal .alert {
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#calibracaoModal .input-group-text {
    background: #e9ecef;
    border-color: #dee2e6;
}

#calibracaoModal .progress {
    height: 25px;
    border-radius: 12px;
}

#calibracaoModal .progress-bar {
    background-color: #ffc107;
    transition: width 0.5s linear;
}

/* Estilos para o modal de configura√ß√µes */
#configModal .card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

#configModal .card:hover {
    transform: translateY(-2px);
}

#configModal .card-header {
    font-weight: bold;
    letter-spacing: 0.5px;
}

#configModal .form-label {
    font-weight: 500;
    color: #444;
}

#configModal input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(0.5);
}

/* Estilos dos hor√°rios */
.horario-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
}

.horario-item:last-child {
    border-bottom: none;
}

.horario-item:hover {
    background-color: #f8f9fa;
}

.horario-hora {
    font-weight: 500;
    color: #2c3e50;
    min-width: 80px;
}

.horario-porcao {
    color: #6c757d;
    font-size: 0.9em;
}

.horario-peso {
    background-color: #e3f2fd;
    padding: 4px 12px;
    border-radius: 15px;
    font-weight: 500;
    color: #0d6efd;
}

.card-body {
    text-align: center;
}





/*novo cardi alimentador manual */
.btn-motor {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.btn-motor:active {
    transform: scale(0.95);
}

.btn-motor::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.3s, height 0.3s;
}

.btn-motor:active::after {
    width: 300px;
    height: 300px;
}



/* Adicione ao seu <style> */
    .btn-limpar {
    background: linear-gradient(145deg, #aaf3f7 0%, #aaf3f7 100%);
    color: #2c3e50 !important;
    border: none;
    border-radius: 8px;
    padding: 6px 15px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-limpar:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    background: linear-gradient(145deg, #aaf3f7 0%, #aaf3f7 100%);
}

.btn-limpar:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.bi-eraser-fill {
    font-size: 1.1em;
    margin-right: 5px;
}


/* Adicione ao seu CSS */
.btn-aqua-gradient {
    background: linear-gradient(145deg, #7fc5fa 0%, #aaf3f7 100%);
    color: #2c3e50;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    transition: all 0.3s ease;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-aqua-gradient:hover {
    background: linear-gradient(145deg, #6cb4e8 0%, #99e3e7 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-aqua-gradient:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}



    </style>
</head>
<body>
    <!-- Tela de Abertura -->
    <div id="splash-screen">
        <img src="englife.png" alt="EngLife Carregando...">
    </div>

    <!-- Conte√∫do Principal (oculto inicialmente) -->
    <div class="container hidden-content">
        <!-- Todo o conte√∫do original aqui -->
        <div class="container content">
            <h1 class="text-center my-4">Monitor de Temperatura</h1>
    
            <!-- Cards de Temperatura -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body d-flex align-items-center">
                            <span class="card-icon text-primary">üå°Ô∏è</span>
                            <div>
                                <h5 class="card-title">Temperatura √Ågua</h5>
                                <p class="card-value text-primary" id="temp1">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body d-flex align-items-center">
                            <span class="card-icon text-success">üå°Ô∏è</span>
                            <div>
                                <h5 class="card-title">Temperatura Ar Estufa</h5>
                                <p class="card-value text-success" id="temp2">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body d-flex align-items-center">
                            <span class="card-icon text-warning">üå°Ô∏è</span>
                            <div>
                                <h5 class="card-title">Temperatura Ar Externo</h5>
                                <p class="card-value text-warning" id="temp3">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
 
            
            <!-- Gr√°fico -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Gr√°fico de Temperaturas</h5>
                    <div id="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>
    
            <!-- Bot√µes -->
<!-- Bot√µes -->
<div class="text-center mt-4">
    <div class="d-flex flex-wrap justify-content-center gap-2 gap-md-3">
        <!-- Month Picker -->
        <div class="btn-group flex-shrink-0" style="min-width: 200px;">
            <label for="monthPicker" class="form-label mb-0 align-self-center me-1">Escolha um M√™s:</label>
            <input type="month" id="monthPicker" class="form-control" 
                   onchange="atualizarPorMes()"
                   min="2023-01" 
                   max="2025-12"
                   title="Selecionar m√™s espec√≠fico">
        </div>

        <!-- Dropdown Per√≠odo -->
        <div class="btn-group flex-shrink-0" style="min-width: 200px;">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                Selecionar Per√≠odo
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="selecionarPeriodo('24h')">√öltimas 24 horas</a></li>
                <li><a class="dropdown-item" href="#" onclick="selecionarPeriodo('semana')">√öltima Semana</a></li>
                <li><a class="dropdown-item" href="#" onclick="selecionarPeriodo('mes')">√öltimo M√™s</a></li>
                <li><a class="dropdown-item" href="#" onclick="selecionarPeriodo('ano')">Registro completo</a></li>
            </ul>
        </div>

        <!-- Dropdown Download -->
        <div class="btn-group flex-shrink-0" style="min-width: 200px;">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                Baixar Dados
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="baixarDados('xlsx')">Baixar em XLSX</a></li>
                <li><a class="dropdown-item" href="#" onclick="baixarDados('txt')">Baixar em TXT</a></li>
            </ul>
        </div>

        <!-- Dropdown Sensores -->
        <div class="btn-group flex-shrink-0" style="min-width: 200px;">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                Selecionar Sensores
            </button>
            <ul class="dropdown-menu">
                <li class="dropdown-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggleAgua" checked>
                        <label class="form-check-label" for="toggleAgua">√Ågua</label>
                    </div>
                </li>
                <li class="dropdown-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggleEstufa" checked>
                        <label class="form-check-label" for="toggleEstufa">Ar Estufa</label>
                    </div>
                </li>
                <li class="dropdown-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggleExterno" checked>
                        <label class="form-check-label" for="toggleExterno">Ar Externo</label>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>

</div>
        <div class="col-md-12 mt-4">
            
            <div class="card">
                
                <div class="card-body">
                    <div class="card-body text-center"></div>
                    <h5 class="card-title">An√°lise de Sensibilidade</h5>
                    <div id="regressionResults"></div>
                    <div id="timeLagResults" class="mt-3"></div>
                
                </div>
            </div>
        </div>
                    

<!-- Painel Principal -->
<div class="config-panel" id="configPanel">
    <div class="text-center mt-4">
        <div class="d-flex flex-md-row flex-column justify-content-center gap-md-3 gap-2">
            <!-- Bot√µes de Configura√ß√£o -->
            <button class="btn btn-aqua-gradient mb-md-0 mb-2" onclick="abrirConfiguracoes()">
                ‚öôÔ∏è Configura√ß√µes do Alimentador
            </button>
            <button class="btn btn-aqua-gradient mb-md-0 mb-2" onclick="mostrarHorarios()">
                üïí Ver Hor√°rios Agendados
            </button>
            <button class="btn btn-aqua-gradient mb-md-0 mb-2" onclick="abrirVentiladorModal()">
                üåÄ Controle do Ventilador
            </button>
            <button class="btn btn-aqua-gradient mb-md-0 mb-2" onclick="abrirTermicoModal()">
                üå°Ô∏è Par√¢metros T√©rmicos
            </button>
        </div>
    </div>
    
    <!-- Notifica√ß√£o e Alertas -->
    <div id="notification" class="alert alert-success mt-3" role="alert" style="display: none;"></div>
    <div id="alertContainer" class="alert-container mt-3"></div>
</div>
                

           

        </div>
          
        <a href="https://wa.me/+5519996058199" class="help-icon" target="_blank">
            <img src="ajuda.png" alt="Ajuda">
        </a>

<!-- Novo Modal de Par√¢metros T√©rmicos -->
<div class="modal fade" id="termicoModal" tabindex="-1" aria-labelledby="termicoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="termicoModalLabel">üå°Ô∏è Par√¢metros de Conforto T√©rmico</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Configura√ß√£o para √Ågua -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">√Ågua</h5>
                                <div class="mb-3">
                                    <label class="form-label">M√°xima (¬∞C)</label>
                                    <input type="number" step="0.1" id="maxAgua" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">M√≠nima (¬∞C)</label>
                                    <input type="number" step="0.1" id="minAgua" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√£o para Ar Estufa -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Ar Estufa</h5>
                                <div class="mb-3">
                                    <label class="form-label">M√°xima (¬∞C)</label>
                                    <input type="number" step="0.1" id="maxEstufa" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">M√≠nima (¬∞C)</label>
                                    <input type="number" step="0.1" id="minEstufa" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√£o para Ar Externo -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Ar Externo</h5>
                                <div class="mb-3">
                                    <label class="form-label">M√°xima (¬∞C)</label>
                                    <input type="number" step="0.1" id="maxExterno" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">M√≠nima (¬∞C)</label>
                                    <input type="number" step="0.1" id="minExterno" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> Estes par√¢metros definem as faixas de temperatura ideais para o sistema.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarConfigTermica()">Salvar Configura√ß√µes</button>
            </div>
        </div>
    </div>
</div>


        
        <!-- Modal de Configura√ß√µes -->
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="configModalLabel">Configura√ß√µes do Alimentador</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-warning">
                                <h5 class="card-title mb-0">Calibra√ß√£o</h5>
                            </div>
                            <div class="card-body text-center">
                                <button class="btn btn-warning" onclick="iniciarCalibracao()">
                                    üîß Iniciar Calibra√ß√£o
                                </button>
                               
                                <p class="text-muted mt-2">Calibre o sistema de dosagem</p>
                            </div>
                            <div class="card mb-3">
                                <div class="card-header bg-info">
                                    <h5 class="card-title mb-0">Controle Manual</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label>Quantidade de Ra√ß√£o (gramas)</label>
                                        <input type="number" id="manualFeedInput" class="form-control" min="0">
                                    </div>
                                    <button class="btn btn-info w-100 mb-2" onclick="enviarRacaoManual()">
                                        üöú Liberar Ra√ß√£o Manualmente
                                    </button>
                                    <button class="btn btn-danger w-100" onclick="acionarMotor()">
                                        ‚ö° Acionar Motor Agora
                                    </button>
                                </div>
                    </div>   
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">Configura√ß√µes de Alimenta√ß√£o</h5>
                            </div>
                            <div class="card-body">
                                <form id="configForm">
                                    <div class="mb-3">
                                        <label class="form-label">Hor√°rio In√≠cio</label>
                                        <input type="time" class="form-control" id="horarioInicio" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Hor√°rio Fim</label>
                                        <input type="time" class="form-control" id="horarioFim" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Peso Di√°rio (gramas)</label>
                                        <input type="number" class="form-control" id="pesoDiario" min="0" step="0.01" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">N√∫mero de Por√ß√µes</label>
                                        <input type="number" class="form-control" id="porcoes" min="1" max="100" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Lan√ßamentos por Dia</label>
                                        <input type="number" class="form-control" id="lancamentos" min="1" max="100" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Intervalo (minutos)</label>
                                        <input type="number" class="form-control" id="intervalo" min="1" max="120" required>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success w-100">
                                        üíæ Salvar Configura√ß√µes
                                    </button>
                                    
                                    
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>    
   
<!-- Modal de Hor√°rios -->
<div class="modal fade" id="horariosModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Hor√°rios Agendados e Hist√≥rico</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Se√ß√£o de Hor√°rios Agendados -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">Agendamento Programado</h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="lista-horarios" class="list-group list-group-flush">
                            <!-- Hor√°rios ser√£o inseridos aqui -->
                        </div>
                        <div id="sem-horarios" class="text-muted text-center p-3" style="display: none;">
                            Nenhum hor√°rio agendado
                        </div>
                    </div>
                </div>

                <!-- Card de Hist√≥rico -->
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Hist√≥rico de Alimenta√ß√µes</h6>
                        <div id="total-racao" class="badge bg-light text-dark">Total: 0g</div>
                    </div>
                    <div class="card-body p-0">
                        <div id="historico-ativacoes" 
                            class="list-group list-group-flush" 
                            style="max-height: 300px; overflow-y: auto;">
                            <!-- Itens do hist√≥rico -->
                        </div>
                        <div id="sem-historico" class="text-muted text-center p-3" style="display: none;">
                            Nenhum registro hist√≥rico encontrado
                        </div>
                    </div>
                </div>
                <!-- Dentro do modal-body do #horariosModal -->
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-3"> <!-- Bootstrap gap + CSS personalizado -->
                            <button class="btn btn-limpar" onclick="baixarHistorico()">
                                üì• Baixar Hist√≥rico
                            </button>
                            
                            <button class="btn btn-limpar" onclick="limparHistorico()">
                                üóëÔ∏è Limpar Hist√≥rico
                            </button>
                        </div>
                    </div>
                    <!-- ... resto do c√≥digo do hist√≥rico ... -->
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- Modal de Calibra√ß√£o -->
        <div class="modal fade" id="calibracaoModal" tabindex="-1" aria-labelledby="calibracaoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title" id="calibracaoModalLabel">üîß Calibra√ß√£o do Sistema</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="etapa0">
                            <h5 class="text-center mb-4">Instru√ß√µes Iniciais</h5>
                            <ol>
                                <li>Certifique se que o sistema esta carregado</li>
                                <li>Posicione o recipiente VAZIO na balan√ßa</li>
                                <li>Certifique-se que o sistema est√° est√°vel</li>
                                <li>Clique em "Iniciar Calibra√ß√£o" abaixo</li>
                                <li>
                                    Se o sistema estiver vazio, utilize o bot√£o 
                                    <span class="badge bg-info">‚ö° Libera√ß√£o Manual</span> 
                                    para preencher o mecanismo de alimenta√ß√£o
                                </
                            </ol>
                            <div class="text-center">
                                <button class="btn btn-warning" onclick="iniciarEtapa(1)">Iniciar Calibra√ß√£o</button>
                            </div>
                        </div>

                        <div id="etapa1" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Etapa 1/3:</strong> Motor ligado por <span id="tempo1Value"></span> segundos
                            </div>
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                    id="progressEtapa1" style="width: 0%"></div>
                            </div>
                        </div>

                        <div id="etapa2" style="display: none;">
                            <div class="alert alert-primary">
                                <strong>Etapa 2/3:</strong> Aguarde e Insira o peso medido ap√≥s a primeira descarga
                            </div>
                            <div class="input-group mb-3">
                                <input type="number" id="peso1Input" class="form-control" 
                                    placeholder="Peso em gramas" step="1" min="0">
                                <span class="input-group-text">gramas</span>
                            </div>
                            <button class="btn btn-primary w-100" onclick="avancarParaEtapa3()">Confirmar Peso</button>
                        </div>

                        <div id="etapa3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Etapa 3/3:</strong> Motor ligado por <span id="tempo2Value"></span> segundos
                            </div>
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                    id="progressEtapa3" style="width: 0%"></div>
                            </div>
                        </div>

                        <div id="etapa4" style="display: none;">
                            <div class="alert alert-success">
                                <strong>Etapa Final:</strong> Aguarde e Insira o peso medido ap√≥s a segunda descarga
                            </div>
                            <div class="input-group mb-3">
                                <input type="number" id="peso2Input" class="form-control" 
                                    placeholder="Peso em gramas" step="1" min="0">
                                <span class="input-group-text">gramas</span>
                            </div>
                        <button class="btn btn-success w-100" onclick="finalizarCalibracao()">Finalizar Calibra√ß√£o</button>
                        </div>
                    </div>
                </div>
            </div>
         
</div>
<!-- Adicione este c√≥digo ap√≥s o modal de hor√°rios existente -->

<!-- Modal do Ventilador -->
<div class="modal fade" id="ventiladorModal" tabindex="-1" aria-labelledby="ventiladorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ventiladorModalLabel">üîÑ Controle do Ventilador</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Controle Manual -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">Controle Manual</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="modoManualVentilador">
                                    <label class="form-check-label" for="modoManualVentilador">Modo Manual</label>
                                </div>
                                
                                <div id="controleManualContainer" style="display: none;">
                                    <div class="d-flex justify-content-center gap-3 mb-3">
                                        <button class="btn btn-success" id="ligarVentiladorBtn">Ligar Ventilador</button>
                                        <button class="btn btn-danger" id="desligarVentiladorBtn">Desligar Ventilador</button>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <small>‚ö†Ô∏è No modo manual, o sistema autom√°tico √© desativado. 
                                        Voc√™ assume total controle do ventilador.</small>
                                    </div>
                                </div>
                                
                                <div id="statusVentilador" class="text-center mt-3">
                                    <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                                    <span>Carregando status...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√µes Autom√°ticas -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">Configura√ß√µes Autom√°ticas</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="tempMaxVentilador" class="form-label">Temperatura M√°xima (¬∫C)</label>
                                    <input type="number" step="0.1" class="form-control" id="tempMaxVentilador">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tempMinDesligar" class="form-label">Temperatura para Desligar (¬∫C)</label>
                                    <input type="number" step="0.1" class="form-control" id="tempMinDesligar">
                                </div>
                                
                                <button class="btn btn-success w-100" id="salvarConfigVentiladorBtn">
                                    üíæ Salvar Configura√ß√µes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hist√≥rico de Opera√ß√£o -->
                <div class="card">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Hist√≥rico de Opera√ß√£o</h5>
                        <div>
                            <button class="btn btn-sm btn-light" onclick="baixarHistoricoVentilador()">
                                üì• Baixar
                            </button>
                            <button class="btn btn-sm btn-light" onclick="limparHistoricoVentilador()">
                                üóëÔ∏è Limpar
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Estado</th>
                                        <th>Modo</th>
                                        <th>Temperatura</th>
                                        <th>Dura√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="historicoVentiladorBody">
                                    <!-- Dados ser√£o inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                        <div id="semHistoricoVentilador" class="text-center py-4 text-muted">
                            Nenhum registro hist√≥rico encontrado
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>


</div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Remova a linha anterior do ml-regression-multivariate-linear -->
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.2.0/math.min.js"></script>
    <script>window.ignoreSourceMapWarning = true;</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Certifique-se que o Bootstrap JS est√° carregado antes dos seus scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Carrega jQuery antes de seus scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Scripts -->
    <script>
        // Controle da tela de abertura
        window.addEventListener('load', function() {
            setTimeout(() => {
                const splashScreen = document.getElementById('splash-screen');
                const mainContent = document.querySelector('.hidden-content');
                
                splashScreen.style.opacity = '0';
                mainContent.style.opacity = '1';
                
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 1000);
                
            }, 3000); // 3 segundos de exibi√ß√£o
        });

         // Restante do c√≥digo Firebase...
        const firebaseConfig = {
            apiKey: "AIzaSyAMAf30UG0YOqaxF-KgD5gfAhWhddN-5Qg",
            authDomain: "datalogeer.firebaseapp.com",
            databaseURL: "https://datalogeer-default-rtdb.firebaseio.com/",
            projectId: "datalogeer",
            storageBucket: "datalogeer.appspot.com",
        };


        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);
        const sensoresRef = database.ref('sensores');
        
        const temperaturasAnoRef = database.ref('temperaturas_ano'); // Adicione esta linha com as outras refs
          // Adicione ap√≥s a inicializa√ß√£o do Firebase
        const thresholdsRef = database.ref('alert_thresholds');
        const temp1Element = document.getElementById('temp1');
        const temp2Element = document.getElementById('temp2');
        const temp3Element = document.getElementById('temp3');
        
        // Atualize o dbRefs para:
        const dbRefs = {
            '24h': temperaturasAnoRef,
            'semana': temperaturasAnoRef,
            'mes': temperaturasAnoRef,
            'ano': temperaturasAnoRef,
            'personalizado': temperaturasAnoRef
        };
        let periodoSelecionado = '24h'; // Padr√£o para as √∫ltimas 24 horas
        let temp1 = [], temp2 = [], temp3 = [];

        const ctx = document.getElementById('temperatureChart').getContext('2d');
        // Controle de visibilidade das s√©ries
        document.getElementById('toggleAgua').addEventListener('change', function() {
            chart.data.datasets[0].hidden = !this.checked;
            chart.update();
        });

        document.getElementById('toggleEstufa').addEventListener('change', function() {
            chart.data.datasets[1].hidden = !this.checked;
            chart.update();
        });

        document.getElementById('toggleExterno').addEventListener('change', function() {
            chart.data.datasets[2].hidden = !this.checked;
            chart.update();
        });
        document.querySelectorAll('.toggle-sensor').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const datasetIndex = parseInt(this.dataset.index);
                chart.data.datasets[datasetIndex].hidden = !this.checked;
                chart.update();
            });
        });
        // Modifique a configura√ß√£o do gr√°fico para incluir a propriedade hidden
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Temperatura √Ågua',
                        data: temp3,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        fill: false,
                        hidden: false
                    },
                    {
                        label: 'Temperatura Ar Estufa',
                        data: temp2,
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        fill: false,
                        hidden: false
                    },
                    {
                        label: 'Temperatura Ar Externo',
                        data: temp1,
                        borderColor: 'orange',
                        backgroundColor: 'rgba(255, 165, 0, 0.1)',
                        fill: false,
                        hidden: false
                    },
                ],
            },
            
            options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Temperatura (¬∞C)' },
                        },
                        x: { title: { display: true, text: 'Tempo' } },
                    },
                    
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                filter: (legendItem, chartData) => {
                                    // Mostra apenas legendas para datasets vis√≠veis
                                    return !chartData.datasets[legendItem.datasetIndex].hidden;
                                }
                            }
                        }
                    }
                },
        });
        
       // Para per√≠odos pr√©-definidos
        function selecionarPeriodo(periodo) {
            periodoSelecionado = periodo;
            mesSelecionado = null;
            anoSelecionado = null;
            document.getElementById('monthPicker').value = '';
            atualizarTemperaturas();
        }

        // Para sele√ß√£o de m√™s personalizado
        function atualizarPorMes() {
            const selected = document.getElementById('monthPicker').value;
            if (selected) {
                [anoSelecionado, mesSelecionado] = selected.split('-').map(Number);
                periodoSelecionado = 'personalizado';
                atualizarTemperaturas();
            }
        }
        async function atualizarAnalise() {
    try {
        // Mostrar loading
        document.getElementById('regressionResults').innerHTML = `
            <div class="text-center my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p>Atualizando an√°lise para per√≠odo: ${periodoSelecionado}</p>
            </div>
        `;

        await prepareData();
        await runAnalysis();
        
    } catch (error) {
        showError(error.message);
    }
}
        function processarDadosTemperatura(data) {
            chart.data.labels = [];
            chart.data.datasets.forEach(dataset => dataset.data = []);

            for (const timestamp in data) {
                if (data.hasOwnProperty(timestamp)) {
                    const temperaturaData = data[timestamp];
                    const [dataParte, horaParte] = timestamp.split('_');
                    const [ano, mes, dia] = dataParte.split('-');
                    const [hora, minuto, segundo] = horaParte.split('-');
                    const dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;

                    chart.data.labels.push(dataFormatada);
                    chart.data.datasets[0].data.push(temperaturaData.agua || null);
                    chart.data.datasets[1].data.push(temperaturaData.estufa || null);
                    chart.data.datasets[2].data.push(temperaturaData.externa || null);
                }
            }

            chart.update();
        }

        function lerSensores() {
            sensoresRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    temp1Element.textContent = `${(data.temperatura_3 || 0).toFixed(2)} ¬∞C`;
                    temp2Element.textContent = `${(data.temperatura_2 || 0).toFixed(2)} ¬∞C`;
                    temp3Element.textContent = `${(data.temperatura_1 || 0).toFixed(2)} ¬∞C`;
                    verificarAlertas(data);
                } else {
                    console.log("Nenhum dado encontrado no n√≥ sensores.");
                    exibirNotificacao('Erro ao conectar com o Firebase.', 'danger');
                }
            }, (error) => {
                console.error("Erro ao ler os dados dos sensores:", error);
                alert("Erro ao conectar com o Firebase!");
            });
        }

        function lerTemperaturas() {
    const ref = dbRefs[periodoSelecionado];
    
    ref.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            let filteredData;
            
            if (periodoSelecionado === 'personalizado') {
                filteredData = filtrarPorMes(data);
            } else {
                filteredData = filtrarPorPeriodo(data, periodoSelecionado);
            }

            processarDadosTemperatura(filteredData);
            prepareData().then(runAnalysis);
        } else {
            alert("Nenhum dado encontrado para o per√≠odo selecionado.");
        }
    }).catch(error => {
        console.error("Erro:", error);
        alert("Erro ao carregar dados!");
    });
}

        function filtrarPorMes(data) {
            const filtered = {};
            const mesFormatado = mesSelecionado.toString().padStart(2, '0');
            
            for (const key in data) {
                const [datePart] = key.split('_');
                const [year, month] = datePart.split('-');
                if (year === anoSelecionado.toString() && month === mesFormatado) {
                    filtered[key] = data[key];
                }
            }
            return filtered;
        }

        function atualizarTemperaturas() {
            lerSensores();
            lerTemperaturas();
        }

        function exibirNotificacao(mensagem, tipo = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = mensagem;
    notification.className = `alert alert-${tipo} show`;
    if (!mensagem) return; // N√£o exibe se n√£o houver mensagem

    notification.textContent = mensagem;
    notification.classList.remove('alert-success', 'alert-danger', 'show');
    
    // Reset animation
    void notification.offsetWidth;
    
    notification.classList.add(tipo === 'success' ? 'alert-success' : 'alert-danger');
    notification.style.display = 'block';
    notification.classList.add('show');

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.style.display = 'none';
        }, 300);
    }, 5000);
}

function baixarDados(tipo) {
    const ref = database.ref('temperaturas_ano');
    
    ref.once('value').then((snapshot) => {
        const rawData = snapshot.val();
        if (!rawData) {
            exibirNotificacao('Nenhum dado encontrado para download!', 'warning');
            return;
        }

        // Aplicar filtro conforme per√≠odo selecionado
        let filteredData;
        if (periodoSelecionado === 'personalizado' && mesSelecionado && anoSelecionado) {
            filteredData = filtrarPorMes(rawData);
        } else {
            filteredData = filtrarPorPeriodo(rawData, periodoSelecionado);
        }

        if (Object.keys(filteredData).length === 0) {
            exibirNotificacao('Nenhum dado no per√≠odo selecionado!', 'warning');
            return;
        }

        // Processar dados para download
        const header = 'Data\tHora\tTemperatura √Ågua (¬∫C)\tTemperatura Estufa (¬∫C)\tTemperatura Externa (¬∫C)';
        const data = [header];

        // Ordenar as chaves cronologicamente
        const sortedKeys = Object.keys(filteredData).sort((a, b) => {
            const dateA = new Date(a.replace('_', ' ').replace(/-/g, '/'));
            const dateB = new Date(b.replace('_', ' ').replace(/-/g, '/'));
            return dateA - dateB;
        });

        sortedKeys.forEach(key => {
            const tempData = filteredData[key];
            const [dataParte, horaParte] = key.split('_');
            const [ano, mes, dia] = dataParte.split('-');
            const [hora, minuto, segundo] = horaParte.split('-');
            
            const linha = [
                `${dia}/${mes}/${ano}`,          // Data formatada DD/MM/YYYY
                `${hora}:${minuto}:${segundo}`,  // Hora formatada HH:MM:SS
                tempData.agua?.toFixed(2) || 'N/A', 
                tempData.estufa?.toFixed(2) || 'N/A', 
                tempData.externa?.toFixed(2) || 'N/A'
            ].join('\t');

            data.push(linha);
        });

        // Gerar nome do arquivo
        let fileName = `Dados_Temperatura_${periodoSelecionado}`;
        if (periodoSelecionado === 'personalizado') {
            fileName = `Dados_Temperatura_${mesSelecionado.toString().padStart(2, '0')}-${anoSelecionado}`;
        }

        // Gerar arquivo
        if (tipo === 'xlsx') {
            const ws = XLSX.utils.aoa_to_sheet(data.map(item => item.split('\t')));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Temperaturas');
            XLSX.writeFile(wb, `${fileName}.xlsx`);
        } else if (tipo === 'txt') {
            const blob = new Blob([data.join('\n')], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        exibirNotificacao(`Download iniciado: ${fileName}`, 'success');

    }).catch(error => {
        console.error('Erro ao baixar dados:', error);
        exibirNotificacao('Falha ao baixar dados!', 'danger');
    });
}


      

        // Fun√ß√µes de Configura√ß√£o
        function toggleConfig() {
                    const panel = document.getElementById('configPanel');
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                }

                function carregarConfig() {
                    thresholdsRef.on('value', (snapshot) => {
                        if (snapshot.exists()) {
                            alertThresholds = snapshot.val();
                            document.getElementById('maxAgua').value = alertThresholds.agua.max;
                            document.getElementById('minAgua').value = alertThresholds.agua.min;
                            document.getElementById('maxEstufa').value = alertThresholds.estufa.max;
                            document.getElementById('minEstufa').value = alertThresholds.estufa.min;
                            document.getElementById('maxExterno').value = alertThresholds.externa.max;
                            document.getElementById('minExterno').value = alertThresholds.externa.min;
                        }
                    });
                }

                function salvarConfig() {
                    const newConfig = {
                        agua: {
                            max: parseFloat(document.getElementById('maxAgua').value),
                            min: parseFloat(document.getElementById('minAgua').value)
                        },
                        estufa: {
                            max: parseFloat(document.getElementById('maxEstufa').value),
                            min: parseFloat(document.getElementById('minEstufa').value)
                        },
                        externa: {
                            max: parseFloat(document.getElementById('maxExterno').value),
                            min: parseFloat(document.getElementById('minExterno').value)
                        }
                    };

                    thresholdsRef.set(newConfig)
                        .then(() => exibirNotificacao('Configura√ß√µes salvas com sucesso!', 'success'))
                        .catch((error) => exibirNotificacao('Erro ao salvar: ' + error.message, 'danger'));
                }

function verificarAlertas(data) {
    // Certifique-se que alertThresholds est√° carregado
    if (!alertThresholds) {
        console.warn("Limites de alerta n√£o carregados");
        return;
    }

    const cards = {
        agua: document.getElementById('temp1'),
        estufa: document.getElementById('temp2'),
        externa: document.getElementById('temp3')
    };

    Object.keys(alertThresholds).forEach((sensor) => {
        const valor = data[`temperatura_${sensor === 'agua' ? 3 : sensor === 'estufa' ? 2 : 1}`];
        const card = cards[sensor];

        if (card && alertThresholds[sensor]) {
            const max = alertThresholds[sensor].max;
            const min = alertThresholds[sensor].min;
            
            card.classList.toggle('sensor-alert', valor > max || valor < min);

            let alertIcon = card.querySelector('.alert-icon');
            if (card.classList.contains('sensor-alert')) {
                if (!alertIcon) {
                    alertIcon = document.createElement('span');
                    alertIcon.classList.add('alert-icon');
                    alertIcon.innerHTML = '‚ö†Ô∏è';
                    card.prepend(alertIcon);
                }
            } else {
                if (alertIcon) alertIcon.remove();
            }
        }
    });
}


let historicalData = [];

async function prepareData() {
    try {
        const ref = dbRefs[periodoSelecionado];
        const snapshot = await ref.once('value');
        const rawData = snapshot.val();
        
        historicalData = [];
        
        let filteredData;
        
        // Aplicar filtro conforme o per√≠odo selecionado
        if (periodoSelecionado === 'personalizado') {
            filteredData = filtrarPorMes(rawData);
        } else {
            filteredData = filtrarPorPeriodo(rawData, periodoSelecionado);
        }

        // Processar e ordenar os dados
        for (const timestamp in filteredData) {
            if (filteredData.hasOwnProperty(timestamp)) {
                const entry = filteredData[timestamp];
                const [datePart, timePart] = timestamp.split('_');
                const [year, month, day] = datePart.split('-');
                const [hour, minute, second] = timePart.split('-');
                
                historicalData.push({
                    timestamp: new Date(year, month-1, day, hour, minute, second),
                    agua: parseFloat(entry.agua) || 0,
                    estufa: parseFloat(entry.estufa) || 0,
                    externa: parseFloat(entry.externa) || 0
                });
            }
        }

        // Ordenar por timestamp
        historicalData.sort((a, b) => a.timestamp - b.timestamp);

        // Logs para debug
        console.log('Per√≠odo selecionado:', periodoSelecionado);
        console.log('Dados filtrados:', historicalData.length, 'registros');
        console.log('Primeiro registro:', historicalData[0]?.timestamp);
        console.log('√öltimo registro:', historicalData[historicalData.length-1]?.timestamp);

    } catch (error) {
        console.error('Erro no prepareData:', error);
        throw new Error('Falha ao preparar dados para an√°lise');
    }
}

function getRefByPeriod() {
    switch(periodoSelecionado) {
        case '24h': return temperaturasRef;
        case 'semana': return temperaturasSemanaRef;
        case 'mes': return temperaturasMesRef;
        case 'ano': return temperaturasAnoRef;
        default: return temperaturasRef;
    }
}

async function runAnalysis() {
    try {
        await prepareData();

        if (historicalData.length < 10) {
            showError(`M√≠nimo de 10 registros para an√°lise (${historicalData.length} encontrados)`);
            return;
        }

        // 1. Determinar per√≠odo de an√°lise
        let tStart, tEnd;
        if (periodoSelecionado === 'personalizado' && anoSelecionado && mesSelecionado) {
            tStart = new Date(anoSelecionado, mesSelecionado - 1, 1);
            tEnd = new Date(anoSelecionado, mesSelecionado, 0, 23, 59, 59, 999);
        } else {
            tEnd = new Date();
            switch (periodoSelecionado) {
                case '24h': tStart = new Date(tEnd - 86400000); break;
                case 'semana': tStart = new Date(tEnd - 604800000); break;
                case 'mes': tStart = new Date(tEnd - 2592000000); break;
                case 'ano': tStart = new Date(tEnd - 31536000000); break;
                default: tStart = new Date(tEnd - 86400000);
            }
        }
        // 1. Calcular varia√ß√µes
        const variations = calculateVariations(historicalData);

        // 2. Realizar regress√µes
        const coefAgua = olsRegression(variations.Var_Externa, variations.Var_Agua);
        const coefInterna = olsRegression(variations.Var_Externa, variations.Var_Interna);

        // 3. Calcular correla√ß√£o cruzada
        const lag = calculateCrossCorrelation(historicalData.map(d => d.externa), 
                                            historicalData.map(d => d.agua));

        // 4. Calcular intervalos
        const intervaloMedio = calculateAverageInterval(historicalData);
        
        // 5. Calcular resultados finais
        const variacaoMax = 1.5; // Substituir por valor do Firebase
        // 2. Filtrar dados do per√≠odo
        const filteredData = historicalData.filter(entry => 
            entry.timestamp >= tStart && entry.timestamp <= tEnd
        );

        // 3. C√°lculo do tempo fora dos limites
        const limites = alertThresholds.agua;
        let stats = {
            above: 0,
            below: 0,
            total: tEnd - tStart
        };

        let prevTime = tStart;
        let prevTemp = filteredData[0]?.agua;

        filteredData.forEach(entry => {
            const delta = entry.timestamp - prevTime;
            
            if (prevTemp > limites.max) stats.above += delta;
            else if (prevTemp < limites.min) stats.below += delta;
            
            prevTime = entry.timestamp;
            prevTemp = entry.agua;
        });

        // Tempo ap√≥s √∫ltimo registro
        const finalDelta = tEnd - prevTime;
        if (prevTemp > limites.max) stats.above += finalDelta;
        else if (prevTemp < limites.min) stats.below += finalDelta;

        // 4. Calcular porcentagens
        const percentuais = {
            above: (stats.above / stats.total) * 100,
            below: (stats.below / stats.total) * 100,
            within: 100 - ((stats.above + stats.below) / stats.total) * 100
        };

        // 5. Montar objeto de resultados
        const resultados = {
            period: { tStart, tEnd },
            percentuais,
            variacaoAgua: 1 / coefAgua,
            variacaoInterna: 1 / coefInterna,
            tempoReflexao: coefAgua * intervaloMedio*60,
            intervaloMedio,
            unidade: 'minutos'
            // ... outros resultados existentes
        };

        displayResults(resultados);

    } catch (error) {
        showError(error.message);
    }
}
function calculateVariations(data) {
    const variations = {
        Var_Agua: [],
        Var_Interna: [],
        Var_Externa: []
    };

    for (let i = 1; i < data.length; i++) {
        variations.Var_Agua.push(data[i].agua - data[i-1].agua);
        variations.Var_Interna.push(data[i].estufa - data[i-1].estufa);
        variations.Var_Externa.push(data[i].externa - data[i-1].externa);
    }

    return variations;
}

function olsRegression(X, Y) {
    const sumX = X.reduce((a, b) => a + b, 0);
    const sumY = Y.reduce((a, b) => a + b, 0);
    const sumXY = X.reduce((a, _, i) => a + (X[i] * Y[i]), 0);
    const sumX2 = X.reduce((a, b) => a + (b * b), 0);

    const n = X.length;
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    
    return slope;
}

function calculateCrossCorrelation(externa, agua, maxLag = 24) {
    let bestLag = 0;
    let maxCorr = -Infinity;

    for (let lag = 0; lag <= maxLag; lag++) {
        const shiftedExterna = externa.slice(lag);
        const shiftedAgua = agua.slice(0, agua.length - lag);
        
        const corr = pearsonCorrelation(shiftedExterna, shiftedAgua);
        
        if (corr > maxCorr) {
            maxCorr = corr;
            bestLag = lag;
        }
    }

    return bestLag;
}

function pearsonCorrelation(x, y) {
    const n = x.length;
    const meanX = x.reduce((a, b) => a + b, 0) / n;
    const meanY = y.reduce((a, b) => a + b, 0) / n;
    
    let numerator = 0;
    let denominatorX = 0;
    let denominatorY = 0;

    for (let i = 0; i < n; i++) {
        numerator += (x[i] - meanX) * (y[i] - meanY);
        denominatorX += Math.pow(x[i] - meanX, 2);
        denominatorY += Math.pow(y[i] - meanY, 2);
    }

    return numerator / Math.sqrt(denominatorX * denominatorY);
}

function calculateAverageInterval(data) {
    if(data.length < 2) return 0;
    
    // Filtra dados para considerar apenas o per√≠odo selecionado
    const filteredData = data.filter(entry => {
        const age = Date.now() - entry.timestamp;
        switch(periodoSelecionado) {
            case '24h': return age <= 86400000;
            case 'semana': return age <= 604800000;
            case 'mes': return age <= 2592000000;
            default: return true;
        }
    });

    let total = 0;
    for (let i = 1; i < filteredData.length; i++) {
        total += filteredData[i].timestamp - filteredData[i-1].timestamp;
    }
    return (total / (filteredData.length - 1)) / (1000 * 60);
}
function formatTime(minutes) {
    if (minutes < 60) {
        return `${minutes.toFixed(2)} minutos`;
    }
    
    const horas = Math.floor(minutes / 60);
    const min = Math.round(minutes % 60);
    
    if (min === 0) {
        return `${horas} horas`;
    }
    return `${horas} horas e ${min} minutos`;
}

function displayResults(resultados) {
    const { tStart, tEnd } = resultados.period;
    const { above, below, within } = resultados.percentuais;
    
    const diasTotal = (tEnd - tStart) / (1000 * 3600 * 24);
    
    const html = `
        
            
                
                <!-- Metadados -->
                <div class="mt-4 text-muted">
                
                    Per√≠odo analisado: ${historicalData[0].timestamp.toLocaleDateString()} 
                    a ${historicalData[historicalData.length-1].timestamp.toLocaleDateString()}
                
                <li>Tempo de coleta: ${historicalData.length} horas</li>  
               
                <li>Varia√ß√£o externa para 1¬∞C na √°gua: ${resultados.variacaoAgua.toFixed(2)}¬∞C</li>
                <li>Varia√ß√£o externa para 1¬∞C na estufa: ${resultados.variacaoInterna.toFixed(2)}¬∞C</li>
                <li>Tempo de reflex√£o √°gua: ${formatTime(resultados.tempoReflexao)}</li>
                <br><br>    
                
                <h5 class="card-title">Indicador de conforto t√©rmico</h5>
                <div style="height: 20px;"></div>
                <!-- Barra de Progresso -->
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-success" 
                         style="width: ${within}%" 
                         title="Dentro dos limites">
                        ${within.toFixed(1)}%
                    </div>
                    <div class="progress-bar bg-danger" 
                         style="width: ${above}%" 
                         title="Acima do m√°ximo">
                        ${above.toFixed(1)}%
                    </div>
                    <div class="progress-bar bg-warning" 
                         style="width: ${below}%" 
                         title="Abaixo do m√≠nimo">
                        ${below.toFixed(1)}%
                    </div>
                </div>

                <!-- Legenda -->
                <div class="row">
                    <div class="col-md-4">
                        <span class="badge bg-success">Conforto t√©rmico: ${within.toFixed(1)}%</span>
                    </div>
                    <div class="col-md-4">
                        <span class="badge bg-danger">Estresse por calor: ${above.toFixed(1)}%</span>
                    </div>
                    <div class="col-md-4">
                        <span class="badge bg-warning">Estresse por frio: ${below.toFixed(1)}%</span>
                    </div>
                </div>

                </div>
        
    `;

    document.getElementById('regressionResults').innerHTML = html;
}

// No in√≠cio do seu script, ap√≥s carregar o Bootstrap
let modalCalibracao = null;

document.addEventListener('DOMContentLoaded', () => {
    // Inicializar o modal
    const modalElement = document.getElementById('calibracaoModal');
    modalCalibracao = new bootstrap.Modal(modalElement);
    
    // Restante do seu c√≥digo de inicializa√ß√£o...
});        

let tempoRestante = 0;
let intervaloProgresso;

function iniciarCalibracao() {
    // Resetar todos os campos
    document.getElementById('etapa0').style.display = 'block';
    document.getElementById('etapa1').style.display = 'none';
    document.getElementById('etapa2').style.display = 'none';
    document.getElementById('etapa3').style.display = 'none';
    document.getElementById('etapa4').style.display = 'none';
    document.getElementById('peso1Input').value = '';
    document.getElementById('peso2Input').value = '';
    modalCalibracao.show();
}

async function iniciarEtapa(etapa) {
    const db = firebase.database();
    
    if(etapa === 1) {
        // Obter tempos do Firebase
        const snapshot = await db.ref('calibracao').once('value');
        const { tempo1, tempo2 } = snapshot.val();
        
        // Atualizar display
        document.getElementById('tempo1Value').textContent = tempo1;
        document.getElementById('tempo2Value').textContent = tempo2;
        
        // Iniciar primeira etapa
        document.getElementById('etapa0').style.display = 'none';
        document.getElementById('etapa1').style.display = 'block';
        
        // Ativar no Firebase
        await db.ref('calibracao').update({
            ativa: true,
            etapa: 1
        });
        
        iniciarContagemRegressiva(tempo1, 'progressEtapa1', () => {
            document.getElementById('etapa1').style.display = 'none';
            document.getElementById('etapa2').style.display = 'block';
        });
    }
}

function avancarParaEtapa3() {
    const peso1 = document.getElementById('peso1Input').value;
    if(!peso1 || peso1 < 1) {
        alert("Por favor insira um peso v√°lido!");
        return;
    }

    firebase.database().ref('calibracao').update({
        peso1: parseInt(peso1),
        etapa: 2
    }).then(() => {
        document.getElementById('etapa2').style.display = 'none';
        document.getElementById('etapa3').style.display = 'block';
        
        // Obter tempo2 do Firebase
        firebase.database().ref('calibracao/tempo2').once('value').then(snapshot => {
            const tempo2 = snapshot.val();
            iniciarContagemRegressiva(tempo2, 'progressEtapa3', () => {
                document.getElementById('etapa3').style.display = 'none';
                document.getElementById('etapa4').style.display = 'block';
            });
        });
    });
}

function finalizarCalibracao() {
    const peso2 = document.getElementById('peso2Input').value;
    if(!peso2 || peso2 < 1) {
        alert("Por favor insira um peso v√°lido!");
        return;
    }

    // Desabilitar bot√£o para evitar m√∫ltiplos cliques
    const btn = document.querySelector('#etapa4 button');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processando...';

    // Primeiro atualiza o peso2
    firebase.database().ref('calibracao').update({
        peso2: parseInt(peso2)
    }).then(() => {
        // Delay de 5 segundos antes de desativar
        setTimeout(() => {
            firebase.database().ref('calibracao').update({
                ativa: false,
                etapa: 0
            }).then(() => {
                modalCalibracao.hide();
                exibirNotificacao('Calibra√ß√£o conclu√≠da com sucesso!', 'success');
                btn.disabled = false;
                btn.textContent = 'Finalizar Calibra√ß√£o';
            }).catch((error) => {
                console.error("Erro ao finalizar calibra√ß√£o:", error);
                exibirNotificacao('Erro ao finalizar calibra√ß√£o!', 'danger');
                btn.disabled = false;
                btn.textContent = 'Finalizar Calibra√ß√£o';
            });
        }, 5000); // 5000 ms = 5 segundos

    }).catch((error) => {
        console.error("Erro ao salvar peso2:", error);
        exibirNotificacao('Erro ao salvar peso!', 'danger');
        btn.disabled = false;
        btn.textContent = 'Finalizar Calibra√ß√£o';
    });
}

function iniciarContagemRegressiva(segundos, elementId, callback) {
    let progresso = 0;
    const elemento = document.getElementById(elementId);
    
    intervaloProgresso = setInterval(() => {
        progresso += (100 / segundos);
        elemento.style.width = `${progresso}%`;
        
        if(progresso >= 100) {
            clearInterval(intervaloProgresso);
            callback();
        }
    }, 1000);
}








// Vari√°vel global para configura√ß√µes
let configuracaoAtual = {};

// Abrir modal de configura√ß√µes
function abrirConfiguracoes() {
    const modal = new bootstrap.Modal(document.getElementById('configModal'));
    
    // Carregar configura√ß√µes do Firebase
    firebase.database().ref('config').once('value').then(snapshot => {
        configuracaoAtual = snapshot.val();
        preencherFormulario(configuracaoAtual);
        modal.show();
    }).catch(error => {
        exibirNotificacao('Erro ao carregar configura√ß√µes!', 'danger');
        console.error(error);
    });
}

// Preencher formul√°rio com dados atuais
function preencherFormulario(dados) {
    document.getElementById('horarioInicio').value = dados.horarioInicio;
    document.getElementById('horarioFim').value = dados.horarioFim;
    document.getElementById('pesoDiario').value = dados.pesoDiario;
    document.getElementById('porcoes').value = dados.porcoes;
    document.getElementById('lancamentos').value = dados.lancamentos;
    document.getElementById('intervalo').value = dados.intervalo;
}

// Salvar configura√ß√µes
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const novoConfig = {
        horarioInicio: document.getElementById('horarioInicio').value,
        horarioFim: document.getElementById('horarioFim').value,
        pesoDiario: parseFloat(document.getElementById('pesoDiario').value),
        porcoes: parseInt(document.getElementById('porcoes').value),
        lancamentos: parseInt(document.getElementById('lancamentos').value),
        intervalo: parseInt(document.getElementById('intervalo').value),
        ativa: true // Adiciona esta linha
    };

    firebase.database().ref('config').update(novoConfig)
        .then(() => {
            exibirNotificacao('Configura√ß√µes salvas e alimentador ativado!', 'success');
            configuracaoAtual = novoConfig;
            $('#configModal').modal('hide');
        })
        
        
});

function mostrarHorarios() {
    const modal = new bootstrap.Modal('#horariosModal');
    
    firebase.database().ref('agendamento').once('value').then(snapshot => {
        const data = snapshot.val();
        atualizarListaHorarios(data);
        modal.show();
    }).catch(error => {
        exibirNotificacao('Erro ao carregar hor√°rios!', 'danger');
        console.error(error);
    });
}

function atualizarListaHorarios(data) {
    const container = document.getElementById('lista-horarios');
    const emptyMsg = document.getElementById('sem-horarios');
    const historicoContainer = document.getElementById('historico-ativacoes');
    const semHistoricoMsg = document.getElementById('sem-historico');
    const totalElement = document.getElementById('total-racao');

    // Limpar conte√∫dos anteriores
    container.innerHTML = '';
    historicoContainer.innerHTML = '';
    totalElement.textContent = 'Total: 0g';

    // ==================== [PARTE 1: HOR√ÅRIOS AGENDADOS] ====================
    if (data && data.porcoes && data.numPorcoes) {
        const numPorcoes = data.numPorcoes;
        const porcoes = Object.values(data.porcoes).slice(0, numPorcoes);

        porcoes.forEach((p, i) => {
            if (p && p.hora !== undefined && p.minuto !== undefined) {
                const div = document.createElement('div');
                div.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                div.innerHTML = `
                    <div class="d-flex align-items-center gap-3">
                        <div>
                            <span class="horario-hora">${p.hora.toString().padStart(2, '0')}:${p.minuto.toString().padStart(2, '0')}</span>
                            <span class="horario-porcao">Por√ß√£o ${i + 1}</span>
                        </div>
                        <!-- LINHA CORRIGIDA (ANTES: parseFloat(p.peso).toFixed(2)) -->
                        <span class="horario-peso">${(Math.round(Number(p.peso) * 100) / 100).toFixed(2)}g</span>
                    </div>
                `;
                
                container.appendChild(div);
            }
        });
        
        emptyMsg.style.display = container.children.length === 0 ? 'block' : 'none';
    } else {
        emptyMsg.style.display = 'block';
    }

    // ==================== [PARTE 2: HIST√ìRICO DE ATIVA√á√ïES] ====================
    firebase.database().ref('historico').once('value').then(historicoSnapshot => {
        const historicoData = historicoSnapshot.val();
        let totalLiberado = 0;

        if (historicoData) {
            const historicoArray = Object.entries(historicoData)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 50);

            historicoArray.forEach(([timestamp, registro]) => {
                try {
                    const [dataParte, horaParte] = timestamp.split('_');
                    const [ano, mes, dia] = dataParte.split('-');
                    const [hora, minuto, segundo] = horaParte.split('-');

                    if (registro.peso && !isNaN(registro.peso)) {
                        totalLiberado += parseFloat(registro.peso);
                    }

                    const div = document.createElement('div');
                    div.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    div.innerHTML = `
                        <div>
                            <small class="text-muted">${dia}/${mes}/${ano}</small><br>
                            <span class="fw-bold">${hora}:${minuto}:${segundo}</span>
                            <span class="text-muted ms-2">${registro.tipo === 'manual' ? '‚úã Manual' : '‚è∞ Agendado'}</span>
                        </div>
                        <!-- LINHA CORRIGIDA (ANTES: parseFloat(registro.peso).toFixed(2)) -->
                        <span class="badge bg-primary rounded-pill">${(Math.round(Number(registro.peso) * 100) / 100).toFixed(2)}g</span>
                    `;

                    historicoContainer.appendChild(div);
                } catch (error) {
                    console.error('Erro ao processar registro:', timestamp, error);
                }
            });

            totalElement.textContent = `Total: ${totalLiberado.toFixed(2)}g`;
            semHistoricoMsg.style.display = historicoArray.length === 0 ? 'block' : 'none';
        } else {
            semHistoricoMsg.style.display = 'block';
        }
    }).catch(error => {
        console.error('Erro ao carregar hist√≥rico:', error);
        semHistoricoMsg.style.display = 'block';
    });
}
function enviarRacaoManual() {
    const peso = document.getElementById('manualFeedInput').value;
    if (peso && peso > 0) {
        firebase.database().ref('controle/peso').set(Number(peso))
            .then(() => {
                exibirNotificacao('Comando de libera√ß√£o enviado!', 'success');
                document.getElementById('manualFeedInput').value = '';
            })
            .catch(error => {
                exibirNotificacao('Erro ao enviar comando!', 'danger');
            });
    } else {
        alert('Insira um valor v√°lido!');
    }
}

function filtrarPorPeriodo(data, periodo) {
    const agora = new Date();
    const filtered = {};
    
    // Calcula o timestamp m√≠nimo com base no per√≠odo
    let minTimestamp;
    switch(periodo) {
        case '24h':
            minTimestamp = agora - (24 * 60 * 60 * 1000);
            break;
        case 'semana':
            minTimestamp = agora - (7 * 24 * 60 * 60 * 1000);
            break;
        case 'mes':
            minTimestamp = agora - (30 * 24 * 60 * 60 * 1000);
            break;
        case 'ano':
            minTimestamp = 0; // Todos os dados
            break;
        default:
            minTimestamp = 0;
    }

    for (const key in data) {
        try {
            // Converte a chave para timestamp
            const [datePart, timePart] = key.split('_');
            const [year, month, day] = datePart.split('-');
            const [hour, min, sec] = timePart.split('-');
            
            const dataDate = new Date(
                parseInt(year),
                parseInt(month) - 1, // Meses s√£o 0-based
                parseInt(day),
                parseInt(hour),
                parseInt(min),
                parseInt(sec)
            );
            
            if (dataDate.getTime() >= minTimestamp) {
                filtered[key] = data[key];
            }
        } catch (e) {
            console.error('Erro ao processar entrada:', key, e);
        }
    }
    
    return filtered;
}






function acionarMotor() {
    firebase.database().ref('motor').set(1)
        .then(() => {
            exibirNotificacao('Motor acionado!', 'success');
            // O backend deve resetar para false ap√≥s o tempo determinado
        })
        .catch(error => {
            exibirNotificacao('Erro ao acionar motor!', 'danger');
        });
}

        // Adicione no final do window.onload
        window.onload = function() {
            // ... c√≥digo existente ...
            carregarConfig();
            lerSensores();
            lerTemperaturas();
            prepareData();
            setTimeout(runAnalysis, 5000); // Executar ap√≥s 5 segundos
        };
                setInterval(atualizarTemperaturas, 3000);
               
                function limparHistorico() {
    if (confirm('Tem certeza que deseja apagar todo o hist√≥rico? Esta a√ß√£o √© irrevers√≠vel!')) {
        firebase.database().ref('historico').remove()
            .then(() => {
                exibirNotificacao('Hist√≥rico limpo com sucesso!', 'success');
                // Atualiza a lista imediatamente
                document.getElementById('historico-ativacoes').innerHTML = '';
                document.getElementById('total-racao').textContent = 'Total: 0g';
                document.getElementById('sem-historico').style.display = 'block';
            })
            .catch((error) => {
                exibirNotificacao('Erro ao limpar hist√≥rico: ' + error.message, 'danger');
            });
    }
}              

// Adicione estas fun√ß√µes ao seu script




function baixarHistorico() {
    const ref = database.ref('historico');
    
    ref.once('value').then(snapshot => {
        const data = snapshot.val();
        if (!data) {
            exibirNotificacao('Nenhum hist√≥rico para baixar!', 'warning');
            return;
        }

        // Formatar dados para CSV
        let csvContent = "Data,Hora,Quantidade (g),Tipo\n";
        
        Object.entries(data).forEach(([timestamp, registro]) => {
            const [dataParte, horaParte] = timestamp.split('_');
            const dataFormatada = dataParte.split('-').reverse().join('/');
            const horaFormatada = horaParte.replace(/-/g, ':');
            
            csvContent += `${dataFormatada},${horaFormatada},${registro.peso.toFixed(2)},${registro.tipo}\n`;
        });

        // Criar arquivo
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.href = url;
        link.download = `historico_alimentacao_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
        link.click();
        
        URL.revokeObjectURL(url);
        exibirNotificacao('Download do hist√≥rico iniciado!', 'success');
    });
}



// Fun√ß√£o para abrir o modal do ventilador
function abrirVentiladorModal() {
    const modal = new bootstrap.Modal(document.getElementById('ventiladorModal'));
    
    // Carregar configura√ß√µes atuais
    firebase.database().ref('ventilador').once('value').then(snapshot => {
        const data = snapshot.val();
        
        // Configurar modo manual
        const modoManual = data?.manual || false;
        document.getElementById('modoManualVentilador').checked = modoManual;
        toggleControleManual(modoManual);
        
        // Configurar status atual
        atualizarStatusVentilador(data?.estado || false);
        
        // Carregar configura√ß√µes autom√°ticas
        firebase.database().ref('alert_thresholds/estufa').once('value').then(thresholds => {
            const valores = thresholds.val();
            if (valores) {
                document.getElementById('tempMaxVentilador').value = valores.max;
                document.getElementById('tempMinDesligar').value = valores.min - 2; // 2¬∞C abaixo do limite
            }
        }).catch(error => {
            console.error("Erro ao carregar thresholds:", error);
        });
        
        // Carregar hist√≥rico
        carregarHistoricoVentilador();
        
        modal.show();
    }).catch(error => {
        exibirNotificacao('Erro ao carregar configura√ß√µes do ventilador!', 'danger');
        console.error(error);
    });
}

// Alternar entre modo manual/autom√°tico
function toggleControleManual(ativo) {
    const container = document.getElementById('controleManualContainer');
    if (container) {
        container.style.display = ativo ? 'block' : 'none';
        
        // Atualizar no Firebase
        firebase.database().ref('ventilador/manual').set(ativo)
            .catch(error => console.error("Erro ao atualizar modo manual:", error));
    }
}

// Atualizar visualiza√ß√£o do status
function atualizarStatusVentilador(ligado) {
    const statusElement = document.getElementById('statusVentilador');
    if (statusElement) {
        const modoManual = document.getElementById('modoManualVentilador')?.checked || false;
        statusElement.innerHTML = `
            <div class="d-flex align-items-center justify-content-center gap-2">
                <div class="rounded-circle bg-${ligado ? 'success' : 'danger'}" 
                     style="width: 15px; height: 15px;"></div>
                <span>Ventilador ${ligado ? 'LIGADO' : 'DESLIGADO'} - Modo ${modoManual ? 'MANUAL' : 'AUTOM√ÅTICO'}</span>
            </div>
        `;
    }
}

// Carregar hist√≥rico do ventilador
function carregarHistoricoVentilador() {
    firebase.database().ref('ventilador/historico').once('value').then(snapshot => {
        const data = snapshot.val();
        const tbody = document.getElementById('historicoVentiladorBody');
        const emptyMsg = document.getElementById('semHistoricoVentilador');
        
        if (tbody) tbody.innerHTML = '';
        
        if (data && Object.keys(data).length > 0) {
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            // Ordenar por timestamp (mais recente primeiro)
            const historicoOrdenado = Object.entries(data)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 50);
            
            historicoOrdenado.forEach(([timestamp, registro]) => {
                try {
                    const [dataParte, horaParte] = timestamp.split('_');
                    const dataFormatada = dataParte.split('-').reverse().join('/');
                    const horaFormatada = horaParte.replace(/-/g, ':');
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${dataFormatada} ${horaFormatada}</td>
                        <td><span class="badge bg-${registro.estado === 'LIGADO' ? 'success' : 'danger'}">${registro.estado}</span></td>
                        <td>${registro.modo || 'N/A'}</td>
                        <td>${registro.temperatura ? registro.temperatura.toFixed(1) + '¬∞C' : 'N/A'}</td>
                        <td>${registro.duracao || 'N/A'}</td>
                    `;
                    if (tbody) tbody.appendChild(tr);
                } catch (e) {
                    console.error("Erro ao processar registro:", timestamp, e);
                }
            });
        } else {
            if (emptyMsg) emptyMsg.style.display = 'block';
        }
    }).catch(error => {
        console.error("Erro ao carregar hist√≥rico:", error);
        if (emptyMsg) emptyMsg.style.display = 'block';
    });
}

// Baixar hist√≥rico em CSV
function baixarHistoricoVentilador() {
    firebase.database().ref('ventilador/historico').once('value').then(snapshot => {
        const data = snapshot.val();
        if (!data || Object.keys(data).length === 0) {
            exibirNotificacao('Nenhum hist√≥rico para baixar!', 'warning');
            return;
        }

        // Formatar dados para CSV
        const csvLines = ["Data,Hora,Estado,Modo,Temperatura (¬∫C),Dura√ß√£o"];
        
        Object.entries(data)
            .sort((a, b) => b[0].localeCompare(a[0]))
            .forEach(([timestamp, registro]) => {
                try {
                    const [dataParte, horaParte] = timestamp.split('_');
                    const dataFormatada = dataParte.split('-').reverse().join('/');
                    const horaFormatada = horaParte.replace(/-/g, ':');
                    
                    csvLines.push(
                        `"${dataFormatada}","${horaFormatada}","${registro.estado}","${registro.modo || ''}",` +
                        `"${registro.temperatura?.toFixed(1) || ''}","${registro.duracao || ''}"`
                    );
                } catch (e) {
                    console.error("Erro ao formatar registro:", timestamp, e);
                }
            });

        // Criar arquivo
        const blob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `historico_ventilador_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
        exibirNotificacao('Download do hist√≥rico iniciado!', 'success');
    }).catch(error => {
        exibirNotificacao('Erro ao baixar hist√≥rico: ' + error.message, 'danger');
    });
}

// Limpar hist√≥rico
function limparHistoricoVentilador() {
    if (confirm('Tem certeza que deseja apagar todo o hist√≥rico do ventilador? Esta a√ß√£o √© irrevers√≠vel!')) {
        firebase.database().ref('ventilador/historico').remove()
            .then(() => {
                exibirNotificacao('Hist√≥rico do ventilador limpo com sucesso!', 'success');
                const tbody = document.getElementById('historicoVentiladorBody');
                if (tbody) tbody.innerHTML = '';
                const emptyMsg = document.getElementById('semHistoricoVentilador');
                if (emptyMsg) emptyMsg.style.display = 'block';
            })
            .catch((error) => {
                exibirNotificacao('Erro ao limpar hist√≥rico: ' + error.message, 'danger');
            });
    }
}

// Configurar event listeners quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', () => {
    // Elementos do DOM
    const modoManualCheckbox = document.getElementById('modoManualVentilador');
    const ligarBtn = document.getElementById('ligarVentiladorBtn');
    const desligarBtn = document.getElementById('desligarVentiladorBtn');
    const salvarConfigBtn = document.getElementById('salvarConfigVentiladorBtn');

    // Verificar se os elementos existem antes de adicionar listeners
    if (modoManualCheckbox) {
        modoManualCheckbox.addEventListener('change', function() {
            toggleControleManual(this.checked);
        });
    }
    
    if (ligarBtn) {
        ligarBtn.addEventListener('click', function() {
            firebase.database().ref('ventilador/estado').set(true)
                .then(() => {
                    exibirNotificacao('Ventilador ligado manualmente', 'success');
                    atualizarStatusVentilador(true);
                })
                .catch(error => {
                    exibirNotificacao('Erro ao ligar ventilador: ' + error.message, 'danger');
                });
        });
    }
    
    if (desligarBtn) {
        desligarBtn.addEventListener('click', function() {
            firebase.database().ref('ventilador/estado').set(false)
                .then(() => {
                    exibirNotificacao('Ventilador desligado manualmente', 'success');
                    atualizarStatusVentilador(false);
                })
                .catch(error => {
                    exibirNotificacao('Erro ao desligar ventilador: ' + error.message, 'danger');
                });
        });
    }
    
    if (salvarConfigBtn) {
        salvarConfigBtn.addEventListener('click', function() {
            const tempMax = parseFloat(document.getElementById('tempMaxVentilador')?.value);
            const tempMinDesligar = parseFloat(document.getElementById('tempMinDesligar')?.value);
            
            if (isNaN(tempMax) || isNaN(tempMinDesligar)) {
                exibirNotificacao('Insira valores num√©ricos v√°lidos!', 'warning');
                return;
            }
            
            firebase.database().ref('alert_thresholds/estufa').update({
                max: tempMax,
                min: tempMinDesligar
            }).then(() => {
                exibirNotificacao('Configura√ß√µes do ventilador salvas!', 'success');
            }).catch(error => {
                exibirNotificacao('Erro ao salvar configura√ß√µes: ' + error.message, 'danger');
            });
        });
    }
});


// Adicione esta fun√ß√£o para registrar eventos do ventilador
function registrarEventoVentilador(estado, temperatura) {
    const agora = new Date();
    const timestamp = `${agora.getFullYear()}-${(agora.getMonth()+1).toString().padStart(2,'0')}-${agora.getDate().toString().padStart(2,'0')}_${agora.getHours().toString().padStart(2,'0')}-${agora.getMinutes().toString().padStart(2,'0')}-${agora.getSeconds().toString().padStart(2,'0')}`;
    
    // Obter o √∫ltimo estado para calcular a dura√ß√£o
    firebase.database().ref('ventilador/ultimoEvento').once('value').then(snapshot => {
        const ultimoEvento = snapshot.val();
        let duracao = 'N/A';
        
        if (ultimoEvento && ultimoEvento.estado !== estado && ultimoEvento.timestamp) {
            // Calcular dura√ß√£o em minutos
            const [dataParte, horaParte] = ultimoEvento.timestamp.split('_');
            const [ano, mes, dia] = dataParte.split('-');
            const [hora, minuto, segundo] = horaParte.split('-');
            
            const ultimaData = new Date(ano, mes-1, dia, hora, minuto, segundo);
            duracao = ((agora - ultimaData) / 60000).toFixed(1) + ' min';
        }
        
        // Registrar novo evento
        const evento = {
            estado: estado ? 'LIGADO' : 'DESLIGADO',
            modo: document.getElementById('modoManualVentilador').checked ? 'MANUAL' : 'AUTOMATICO',
            temperatura: temperatura || null,
            duracao: duracao,
            timestamp: timestamp
        };
        
        // Salvar evento no hist√≥rico
        firebase.database().ref(`ventilador/historico/${timestamp}`).set(evento);
        
        // Atualizar √∫ltimo evento
        firebase.database().ref('ventilador/ultimoEvento').set(evento);
    });
}










// Fun√ß√£o para abrir o modal t√©rmico
// Modifique a fun√ß√£o para debugar
function abrirTermicoModal() {
    try {
        const modalElement = document.getElementById('termicoModal');
        if (!modalElement) {
            throw new Error('Elemento modal n√£o encontrado');
        }

        // Carrega valores do Firebase (com fallback para localStorage)
        firebase.database().ref('alert_thresholds').once('value')
            .then((snapshot) => {
                let config = snapshot.val();
                
                // Se n√£o tiver no Firebase, tenta carregar do localStorage
                if (!config) {
                    const localConfig = localStorage.getItem('configTermica');
                    if (localConfig) {
                        config = JSON.parse(localConfig);
                    } else {
                        // Valores padr√£o
                        config = {
                            agua: { max: 28.0, min: 22.0 },
                            estufa: { max: 30.0, min: 24.0 },
                            externa: { max: 35.0, min: 18.0 }
                        };
                    }
                }

                // Preenche os campos
                $('#maxAgua').val(config.agua?.max || 28.0);
                $('#minAgua').val(config.agua?.min || 22.0);
                $('#maxEstufa').val(config.estufa?.max || 30.0);
                $('#minEstufa').val(config.estufa?.min || 24.0);
                $('#maxExterno').val(config.externa?.max || 35.0);
                $('#minExterno').val(config.externa?.min || 18.0);

                // Abre o modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            })
            .catch((error) => {
                console.error("Erro ao carregar do Firebase:", error);
                // Tenta carregar do localStorage em caso de erro
                const localConfig = localStorage.getItem('configTermica');
                if (localConfig) {
                    const config = JSON.parse(localConfig);
                    $('#maxAgua').val(config.maxAgua);
                    $('#minAgua').val(config.minAgua);
                    $('#maxEstufa').val(config.maxEstufa);
                    $('#minEstufa').val(config.minEstufa);
                    $('#maxExterno').val(config.maxExterno);
                    $('#minExterno').val(config.minExterno);
                    
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    throw new Error('N√£o foi poss√≠vel carregar as configura√ß√µes');
                }
            });

    } catch (error) {
        console.error('Erro ao abrir modal t√©rmico:', error);
        mostrarNotificacao('Erro ao abrir configura√ß√µes t√©rmicas: ' + error.message, "danger");
    }
}
// Fun√ß√£o para validar as configura√ß√µes t√©rmicas
function validarConfigTermica() {
    // Obt√©m todos os valores
    const maxAgua = parseFloat($('#maxAgua').val());
    const minAgua = parseFloat($('#minAgua').val());
    const maxEstufa = parseFloat($('#maxEstufa').val());
    const minEstufa = parseFloat($('#minEstufa').val());
    const maxExterno = parseFloat($('#maxExterno').val());
    const minExterno = parseFloat($('#minExterno').val());

    // Valida√ß√£o b√°sica
    if (isNaN(maxAgua) || isNaN(minAgua) || isNaN(maxEstufa) || 
        isNaN(minEstufa) || isNaN(maxExterno) || isNaN(minExterno)) {
        mostrarNotificacao("Preencha todos os campos com valores num√©ricos v√°lidos!", "danger");
        return false;
    }

    // Valida√ß√£o de faixas (m√≠nimo < m√°ximo)
    if (minAgua >= maxAgua) {
        mostrarNotificacao("Temperatura m√≠nima da √°gua deve ser menor que a m√°xima!", "danger");
        return false;
    }

    if (minEstufa >= maxEstufa) {
        mostrarNotificacao("Temperatura m√≠nima da estufa deve ser menor que a m√°xima!", "danger");
        return false;
    }

    if (minExterno >= maxExterno) {
        mostrarNotificacao("Temperatura m√≠nima externa deve ser menor que a m√°xima!", "danger");
        return false;
    }

    // Valida√ß√µes adicionais de limites f√≠sicos
    if (maxAgua > 40 || minAgua < 10) {
        mostrarNotificacao("Temperatura da √°gua deve estar entre 10¬∞C e 40¬∞C!", "danger");
        return false;
    }

    return true;
}

// Fun√ß√£o para salvar as configura√ß√µes t√©rmicas
function salvarConfigTermica() {
    // Valida os dados antes de salvar
    if (!validarConfigTermica()) {
        return;
    }

    // Cria objeto com as configura√ß√µes
    const configTermica = {
        agua: {
            max: parseFloat($('#maxAgua').val()).toFixed(1),
            min: parseFloat($('#minAgua').val()).toFixed(1)
        },
        estufa: {
            max: parseFloat($('#maxEstufa').val()).toFixed(1),
            min: parseFloat($('#minEstufa').val()).toFixed(1)
        },
        externa: {
            max: parseFloat($('#maxExterno').val()).toFixed(1),
            min: parseFloat($('#minExterno').val()).toFixed(1)
        },
        ultimaAtualizacao: new Date().toISOString()
    };

    // Salva no Firebase
    firebase.database().ref('alert_thresholds').set(configTermica)
        .then(() => {
            // Salva tamb√©m no localStorage como fallback
            localStorage.setItem('configTermica', JSON.stringify(configTermica));
            
            // Fecha o modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('termicoModal'));
            modal.hide();
            
            // Mostra notifica√ß√£o
            mostrarNotificacao("Configura√ß√µes t√©rmicas salvas com sucesso!", "success");
            
            // Atualiza displays
            atualizarDisplaysTermicos();
        })
        .catch((error) => {
            console.error("Erro ao salvar no Firebase:", error);
            mostrarNotificacao("Erro ao salvar configura√ß√µes no banco de dados!", "danger");
        });
}
// Fun√ß√£o auxiliar para enviar para o servidor (AJAX)
function enviarParaServidor(config) {
    $.ajax({
        url: '/api/config-termica',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(config),
        success: function(response) {
            console.log('Configura√ß√µes t√©rmicas salvas no servidor', response);
        },
        error: function(error) {
            console.error('Erro ao salvar no servidor:', error);
            // Pode adicionar uma notifica√ß√£o opcional aqui
        }
    });
}

// Fun√ß√£o para atualizar displays que mostram as configura√ß√µes
function atualizarDisplaysTermicos() {
    // Implementa√ß√£o espec√≠fica do seu sistema
    console.log('Atualizando displays t√©rmicos...');
    // Exemplo: $('#display-temp-agua').text(`${minAgua}¬∞C - ${maxAgua}¬∞C`);
}

// Fun√ß√£o para mostrar notifica√ß√µes
function mostrarNotificacao(mensagem, tipo) {
    const notification = $('#notification');
    notification.removeClass('alert-success alert-danger alert-warning')
               .addClass(`alert-${tipo}`)
               .text(mensagem)
               .fadeIn();

    setTimeout(() => {
        notification.fadeOut();
    }, 5000);
}

    </script>
</body>
</html>